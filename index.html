<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Publicaciones y Eventos</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  body{font-family:sans-serif;margin:0;padding:0;background:#f5f5f5}
  .section-title{font-size:1.2rem;font-weight:600;margin-bottom:0.5rem}
  .card{background:white;border-radius:1rem;padding:1rem;box-shadow:0 2px 5px rgba(0,0,0,0.1);border:1px solid #e0e0e0;cursor:pointer;transition:transform 0.2s;position:relative}
  .card:hover{transform:scale(1.03)}
  .card img{width:100%;border-radius:0.5rem;margin-bottom:0.5rem;object-fit:cover}
  .flex-scroll{display:flex;overflow-x:auto;gap:1rem;padding-bottom:0.5rem}
  .flex-scroll::-webkit-scrollbar{display:none}
  .modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000}
  .modal{background:white;border-radius:1rem;padding:1.5rem;max-width:600px;width:90%;max-height:90%;overflow-y:auto;position:relative}
  .modal-close{position:absolute;top:10px;right:15px;font-size:1.5rem;cursor:pointer;color:#555}
  .btn-share{margin-top:1rem;padding:0.5rem 1rem;background:#25d366;color:white;border:none;border-radius:0.5rem;cursor:pointer;width:100%;font-size:0.9rem}
  iframe{border-radius:12px;margin-bottom:0.5rem}
</style>
</head>
<body>

<!-- Eventos -->
<section class="px-4 mt-4">
  <h2 class="section-title">ðŸ“… PrÃ³ximos eventos</h2>
  <div id="eventContainer" class="flex-scroll">
    <p class="text-gray-400">Cargando eventos...</p>
  </div>
</section>

<!-- Novedades -->
<main class="p-4 mt-6">
  <h2 class="section-title">âœ¨ Novedades</h2>
  <div id="lista-publicaciones">
    <p class="text-gray-400">Cargando novedades...</p>
  </div>
</main>

<!-- Modal -->
<div id="modal" class="modal-bg">
  <div class="modal">
    <span class="modal-close">&times;</span>
    <div id="modal-content"></div>
    <button id="share-btn" class="btn-share">ðŸ“¤ Compartir WhatsApp</button>
  </div>
</div>

<script>
const URL_SHEET = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSyHmU-0ZwmCIFmwaaiC8FLVhSU4n6GNBh4JGtlgf89LWG-4wVW_7Awh8ICilQi5xd5qDVEnfyC2i2O/pub?output=csv";

// Helpers
function esImagen(url){ return !!url && /\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i.test(url); }
function convertirYouTube(url){
  if(!url) return null;
  let m = url.match(/youtube\.com\/embed\/([a-zA-Z0-9_-]+)/i);
  if(m) return `https://www.youtube.com/embed/${m[1]}`;
  m = url.match(/[?&]v=([a-zA-Z0-9_-]{11})/i);
  if(m) return `https://www.youtube.com/embed/${m[1]}`;
  m = url.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/i);
  if(m) return `https://www.youtube.com/embed/${m[1]}`;
  return null;
}
function convertirSpotify(url){
  if(!url) return null;
  url = url.split("?")[0].replace("/intl-es","");
  const match = url.match(/open\.spotify\.com\/(track|album|playlist)\/([a-zA-Z0-9]+)/);
  if(match) return `https://open.spotify.com/embed/${match[1]}/${match[2]}`;
  return url.includes("embed")?url:null;
}

// Modal
const modal = document.getElementById("modal");
const modalContent = document.getElementById("modal-content");
const shareBtn = document.getElementById("share-btn");
document.querySelector(".modal-close").addEventListener("click",()=>{modal.style.display="none";});
window.addEventListener("click",(e)=>{if(e.target==modal) modal.style.display="none";});

// Compartir
let shareData = {};
shareBtn.addEventListener("click",()=>{
  let msg=`*${shareData.titulo}*\n${shareData.contenido||''}\n`;
  if(shareData.imagen) msg+=`Imagen: ${shareData.imagen}\n`;
  if(shareData.video) msg+=`Video: ${shareData.video}\n`;
  if(shareData.spotify) msg+=`Spotify: ${shareData.spotify}\n`;
  msg+=`\n_Compartido desde SoyIBA_`;
  window.open("https://api.whatsapp.com/send?text="+encodeURIComponent(msg),"_blank");
});

// Cargar datos
async function cargarDatos(){
  const contNovedades = document.getElementById("lista-publicaciones");
  const contEventos = document.getElementById("eventContainer");
  contNovedades.innerHTML="<p class='text-gray-400'>Cargando publicaciones...</p>";
  contEventos.innerHTML="<p class='text-gray-400'>Cargando eventos...</p>";

  try{
    const resp = await fetch(URL_SHEET);
    if(!resp.ok) throw new Error("No se pudo acceder a la hoja");
    const csvText = await resp.text();
    const data = Papa.parse(csvText,{header:true,skipEmptyLines:true}).data.reverse();

    contNovedades.innerHTML="";
    contEventos.innerHTML="";

    data.forEach(raw=>{
      const row = {};
      Object.keys(raw).forEach(k=>row[k.trim().toLowerCase()]=String(raw[k]||"").trim());
      if(!row.tipo) return;

      const titulo = row.titulo||"Sin tÃ­tulo";
      const contenido = row.contenido||"";
      const imagen = row.imagen||"";
      const video = row.video||"";
      const spotify = row.spotify||"";

      if(row.tipo.toLowerCase()==="evento"){
        const card=document.createElement("div");
        card.className="card min-w-[180px]";
        const h3=document.createElement("h3"); h3.textContent=titulo; h3.style.fontWeight="600"; card.appendChild(h3);
        if(imagen && esImagen(imagen)){ const img=document.createElement("img"); img.src=imagen; card.appendChild(img); }

        card.addEventListener("click",()=>{
          modalContent.innerHTML=`<h2 style="font-weight:600;margin-bottom:0.5rem">${titulo}</h2>
          ${contenido?`<p style="margin-bottom:0.5rem">${contenido}</p>`:""}
          ${imagen&&esImagen(imagen)?`<img src="${imagen}" style="width:100%;border-radius:12px;margin-bottom:0.5rem">`:""}
          ${video?`<iframe class="w-full" src="${convertirYouTube(video)}" width="100%" height="250" frameborder="0" allowfullscreen></iframe>`:""}
          ${spotify?`<iframe style="border-radius:12px" src="${convertirSpotify(spotify)}" width="100%" height="80" frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>`:""}`;
          shareData={titulo, contenido, imagen, video, spotify};
          modal.style.display="flex";
        });

        contEventos.appendChild(card);

      } else if(row.tipo.toLowerCase()==="novedad"){
        const card=document.createElement("div");
        card.className="card";
        const h3=document.createElement("h3"); h3.textContent=titulo; h3.style.color="#4f46e5"; h3.style.marginBottom="0.25rem"; card.appendChild(h3);
        if(contenido){ const p=document.createElement("p"); p.textContent=contenido; p.style.fontSize="0.9rem"; p.style.color="#555"; p.style.marginBottom="0.5rem"; card.appendChild(p);}
        if(imagen){ const v = convertirYouTube(imagen); if(v){ const f=document.createElement("iframe"); f.src=v; f.width="100%"; f.height="200"; f.frameBorder="0"; f.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"; f.allowFullscreen=true; card.appendChild(f);}
        else if(esImagen(imagen)){ const img=document.createElement("img"); img.src=imagen; card.appendChild(img);} }
        if(video){ const vid=convertirYouTube(video); if(vid){ const f=document.createElement("iframe"); f.src=vid; f.width="100%"; f.height="200"; f.frameBorder="0"; f.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"; f.allowFullscreen=true; card.appendChild(f); } }
        if(spotify){ const sp = convertirSpotify(spotify); if(sp){ const d=document.createElement("iframe"); d.src=sp; d.width="100%"; d.height="80"; d.frameBorder="0"; d.allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"; card.appendChild(d); } }

        const shareBtnNovedad=document.createElement("button");
        shareBtnNovedad.className="btn-share";
        shareBtnNovedad.textContent="ðŸ“¤ Compartir WhatsApp";
        shareBtnNovedad.addEventListener("click",()=>{ 
          let msg=`*${titulo}*\n${contenido||''}\n`; 
          if(imagen) msg+=`Imagen: ${imagen}\n`;
          if(video) msg+=`Video: ${video}\n`;
          if(spotify) msg+=`Spotify: ${spotify}\n`;
          msg+=`\n_Compartido desde SoyIBA_`;
          window.open("https://api.whatsapp.com/send?text="+encodeURIComponent(msg),"_blank");
        });
        card.appendChild(shareBtnNovedad);

        contNovedades.appendChild(card);
      }
    });
  }catch(e){console.error(e); contNovedades.innerHTML="<p style='color:red'>Error al cargar novedades</p>"; contEventos.innerHTML="<p style='color:red'>Error al cargar eventos</p>";}
}

document.addEventListener("DOMContentLoaded", cargarDatos);
</script>

</body>
</html>
