<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Soy IBA - Novedades</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="icon" href="icon.png" />
<style>
body { background: #f3f7fb; font-family: sans-serif; margin:0; }
.section-hidden { display:none; opacity:0; transform:translateX(50px); transition:0.5s;}
.section-active { display:block; opacity:1; transform:translateX(0); transition:0.5s;}
#lista-publicaciones>div { max-width:500px; margin:auto; }
</style>
</head>
<body class="bg-gray-50">

<!-- Header -->
<header class="sticky top-0 bg-white/80 backdrop-blur-md border-b border-gray-200 p-4 flex justify-between items-center shadow-sm z-50">
  <div class="flex items-center gap-2">
    <img src="https://i.imgur.com/41xX3kW.png" class="w-8 h-8 rounded-full" alt="logo">
    <h1 class="text-lg font-bold">Soy IBA</h1>
  </div>
  <button id="menuBtn" class="p-2 rounded-full hover:bg-gray-100">â˜°</button>
</header>

<!-- Sidebar -->
<aside id="sidebar" class="fixed top-0 right-0 h-full w-64 bg-white shadow-lg transform translate-x-full transition-transform duration-300 z-50 overflow-y-auto p-4">
  <button id="closeSidebar" class="p-2 text-gray-600 hover:text-red-500 mb-4">âœ•</button>
  <p>MisiÃ³n, VisiÃ³n, Horarios, Contacto...</p>
</aside>

<!-- ...mantiene todo lo anterior hasta secciÃ³n de eventos... -->
<!-- Eventos prÃ³ximos -->
<section class="px-4 mt-4">
  <h2 class="text-lg font-semibold mb-2">ðŸ“… PrÃ³ximos eventos</h2>
  <div class="flex overflow-x-auto gap-3 pb-2 no-scrollbar" id="eventContainer">
    <p class="text-gray-400">Cargando eventos...</p>
  </div>
</section>

<!-- Novedades dinÃ¡micas -->
<main class="p-4 space-y-6 mt-4">
  <h2 class="text-lg font-bold mb-4">âœ¨ Novedades</h2>
  <div id="lista-publicaciones">
    <p class="text-center text-gray-400">Cargando novedades...</p>
  </div>
</main>

<script>
const URL_SHEET = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSyHmU-0ZwmCIFmwaaiC8FLVhSU4n6GNBh4JGtlgf89LWG-4wVW_7Awh8ICilQi5xd5qDVEnfyC2i2O/pub?output=csv";

function esImagen(url){ return !!url && /\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i.test(url); }
function convertirEnlaceYouTube(url){ 
  if(!url) return null;
  let m = url.match(/youtube\.com\/embed\/([a-zA-Z0-9_-]+)/i);
  if(m) return `https://www.youtube.com/embed/${m[1]}`;
  m = url.match(/[?&]v=([a-zA-Z0-9_-]{11})/i);
  if(m) return `https://www.youtube.com/embed/${m[1]}`;
  m = url.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/i);
  if(m) return `https://www.youtube.com/embed/${m[1]}`;
  return null;
}
function convertirSpotifyEnEmbed(url){
  if(!url) return null;
  url = url.split("?")[0].replace("/intl-es","");
  const match = url.match(/open\.spotify\.com\/(track|album|playlist)\/([a-zA-Z0-9]+)/);
  if(match) return `https://open.spotify.com/embed/${match[1]}/${match[2]}`;
  return url.includes("embed")?url:null;
}

// Compartir WhatsApp
function crearBotonCompartir(titulo, contenido, imagen, video, spotify){
  const btn = document.createElement("button");
  btn.textContent="ðŸ“¤ Compartir WhatsApp";
  btn.className="mt-3 px-3 py-1 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm w-full";
  btn.addEventListener("click",()=>{
    let msg=`*${titulo}*\n${contenido||''}\n`;
    if(imagen) msg+=`Imagen: ${imagen}\n`;
    if(video) msg+=`Video: ${video}\n`;
    if(spotify) msg+=`Spotify: ${spotify}\n`;
    msg+=`\n_Compartido desde SoyIBA_`;
    window.open("https://api.whatsapp.com/send?text="+encodeURIComponent(msg),"_blank");
  });
  return btn;
}

async function cargarDatos(){
  const contNovedades = document.getElementById("lista-publicaciones");
  const contEventos = document.getElementById("eventContainer");
  contNovedades.innerHTML="<p class='text-center text-gray-400'>Cargando publicaciones...</p>";
  contEventos.innerHTML="<p class='text-gray-400'>Cargando eventos...</p>";

  try{
    const resp = await fetch(URL_SHEET);
    if(!resp.ok) throw new Error("No se pudo acceder a la hoja");
    const csvText = await resp.text();
    const data = Papa.parse(csvText,{header:true,skipEmptyLines:true}).data.reverse();

    // Limpiar contenedores
    contNovedades.innerHTML="";
    contEventos.innerHTML="";

    data.forEach(raw=>{
      const row = {};
      Object.keys(raw).forEach(k=>row[k.trim().toLowerCase()]=String(raw[k]||"").trim());
      if(!row.tipo) return;

      const titulo = row.titulo||"Sin tÃ­tulo";
      const contenido = row.contenido||"";
      const imagen = row.imagen||"";
      const video = row.video||"";
      const spotify = row.spotify||"";

      if(row.tipo.toLowerCase() === "evento"){
        const card = document.createElement("div");
        card.className="cursor-pointer min-w-[180px] bg-white rounded-xl p-3 shadow border border-gray-200 flex-shrink-0 hover:scale-105 transition relative";

        const h3 = document.createElement("h3"); h3.textContent=titulo; h3.className="font-semibold text-sm mb-1"; card.appendChild(h3);
        if(imagen && esImagen(imagen)){ const img=document.createElement("img"); img.src=imagen; img.className="w-full h-28 object-cover rounded-lg mb-1"; card.appendChild(img); }

        const desc = document.createElement("p"); desc.textContent=contenido; desc.className="text-xs text-gray-600 hidden"; card.appendChild(desc);

        const shareBtn = crearBotonCompartir(titulo, contenido, imagen, video, spotify);
        shareBtn.classList.add("text-xs"); shareBtn.style.padding="2px 4px"; shareBtn.style.position="absolute"; shareBtn.style.bottom="4px"; shareBtn.style.right="4px";
        card.appendChild(shareBtn);

        // Toggle descripciÃ³n al hacer clic
        card.addEventListener("click",()=>{ desc.classList.toggle("hidden"); });

        contEventos.appendChild(card);
      } else if(row.tipo.toLowerCase() === "novedad"){
        const card = document.createElement("div");
        card.className="cursor-pointer bg-white rounded-2xl shadow overflow-hidden border border-gray-200 p-4 hover:shadow-lg transition";

        const h3 = document.createElement("h3"); h3.textContent=titulo; h3.className="font-semibold mb-1 text-indigo-600"; card.appendChild(h3);
        if(contenido){ const p=document.createElement("p"); p.textContent=contenido; p.className="text-sm text-gray-600 mb-2"; card.appendChild(p); }

        if(imagen){ 
          const v = convertirEnlaceYouTube(imagen);
          if(v) card.innerHTML+=`<iframe class="w-full h-52 rounded-lg mb-2" src="${v}" frameborder="0" allowfullscreen></iframe>`;
          else if(esImagen(imagen)){ const img=document.createElement("img"); img.src=imagen; img.className="w-full h-48 object-cover rounded-lg mb-2"; card.appendChild(img);}
        }
        if(video){ const vid=convertirEnlaceYouTube(video); if(vid){ const f=document.createElement("div"); f.innerHTML=`<iframe class="w-full h-52 rounded-lg mb-2" src="${vid}" frameborder="0" allowfullscreen></iframe>`; card.appendChild(f); } }
        if(spotify){ const sp = convertirSpotifyEnEmbed(spotify); if(sp){ const d=document.createElement("div"); d.innerHTML=`<iframe style="border-radius:12px" src="${sp}" width="100%" height="152" frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>`; card.appendChild(d); } }

        card.appendChild(crearBotonCompartir(titulo, contenido, imagen, video, spotify));

        contNovedades.appendChild(card);
      }
    });
  }catch(e){ console.error(e); contNovedades.innerHTML="<p class='text-center text-red-500'>Error al cargar publicaciones.</p>"; contEventos.innerHTML="<p class='text-red-500'>Error al cargar eventos.</p>";}
}

document.addEventListener("DOMContentLoaded", cargarDatos);
</script>
