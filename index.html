<!DOCTYPE html>
<html lang="es">
  <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Iglesia - PWA Publicaciones</title>
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="icon.png" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      background-color: #f3f4f6;
    }
    .section-hidden {
      display: none;
    }
    .section-active {
      display: block;
    }
    .nav-btn.active svg,
    .nav-btn.active span {
      color: #4f46e5;
      font-weight: 600;
    }
  </style>
</head>
<body class="flex flex-col min-h-screen">
  <main class="flex-1 p-4">
    <!-- 游 Secci칩n principal -->
    <div id="section-inicio" class="section-active bg-white p-4 rounded-xl shadow-md text-center">
      <h1 class="text-xl font-semibold mb-2">Bienvenido 游뗿</h1>
      <p class="text-gray-600">Explora las publicaciones m치s recientes de la iglesia.</p>
    </div>

    <!-- 游닗 Secci칩n de Publicaciones -->
    <div id="section-publicaciones" class="section-hidden bg-white p-4 rounded-xl shadow-md">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">游닗 Publicaciones</h2>
        <button onclick="cargarPublicaciones()" class="text-sm text-indigo-600 font-medium hover:underline flex items-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v6h6M20 20v-6h-6M4 20l16-16"/>
          </svg>
          Actualizar
        </button>
      </div>
      <div id="lista-publicaciones" class="space-y-3 text-gray-700 text-sm">
        <p class="text-center text-gray-400">Cargando publicaciones...</p>
      </div>
    </div>
  </main>

  <!-- 游님 Barra de navegaci칩n inferior -->
  <nav class="bg-white shadow-inner flex justify-around p-2 border-t">
    <button class="nav-btn flex flex-col items-center active" data-section="inicio">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l9-9 9 9M4 10v10a1 1 0 001 1h6m8-11v10a1 1 0 01-1 1h-6"/>
      </svg>
      <span class="text-xs">Inicio</span>
    </button>

    <button class="nav-btn flex flex-col items-center" data-section="publicaciones">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      <span class="text-xs">Publicaciones</span>
    </button>
  </nav>

  <!-- 游닍 Librer칤a PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
  // 游녤 URL de tu hoja de Google Sheets (CSV)
  const URL_SHEET = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSyHmU-0ZwmCIFmwaaiC8FLVhSU4n6GNBh4JGtlgf89LWG-4wVW_7Awh8ICilQi5xd5qDVEnfyC2i2O/pub?output=csv";

  // 游녤 Cambiar secciones de navegaci칩n
  document.querySelectorAll(".nav-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const sectionId = "section-" + btn.dataset.section;
      document.querySelectorAll("main > div").forEach(div => div.classList.add("section-hidden"));
      document.getElementById(sectionId).classList.remove("section-hidden");
      document.getElementById(sectionId).classList.add("section-active");
    });
  });

  // 游녤 Cargar publicaciones desde Google Sheets
  async function cargarPublicaciones() {
    const contenedor = document.getElementById("lista-publicaciones");
    contenedor.innerHTML = "<p class='text-center text-gray-400'>Cargando publicaciones...</p>";

    try {
      const response = await fetch(URL_SHEET);
      if (!response.ok) throw new Error("No se pudo acceder a la hoja");

      const csvText = await response.text();
      const data = Papa.parse(csvText, { header: true }).data;

      contenedor.innerHTML = "";

      const publicacionesValidas = data.filter(p => p.titulo || p.contenido);

      if (publicacionesValidas.length === 0) {
        contenedor.innerHTML = "<p class='text-center text-gray-400'>No hay publicaciones todav칤a.</p>";
        return;
      }

      // Mostrar publicaciones (m치s recientes primero)
      publicacionesValidas.reverse().forEach(pub => {
        const titulo = pub.titulo || "Sin t칤tulo";
        const contenido = pub.contenido || "";
        const imagen = pub.imagen ? pub.imagen.trim() : "";
        const fecha = pub.fecha || "";

        const card = document.createElement("div");
        card.className = "p-4 bg-gray-50 border border-gray-200 rounded-xl shadow-sm";

        card.innerHTML = `
          <h3 class="font-semibold text-indigo-600 text-base">${titulo}</h3>
          <p class="mt-1 whitespace-pre-line">${contenido}</p>
          ${imagen ? `<img src="${imagen}" class="w-full mt-2 rounded-lg shadow-sm">` : ""}
          <p class="text-xs text-gray-500 mt-2 text-right">${fecha}</p>
        `;

        contenedor.appendChild(card);
      });

    } catch (error) {
      console.error(error);
      contenedor.innerHTML = "<p class='text-center text-red-500'>Error al cargar publicaciones.</p>";
    }
  }

  // Cargar al iniciar
  document.addEventListener("DOMContentLoaded", cargarPublicaciones);

 </script>
  <!-- PapaParse (si no lo tienes ya) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const URL_SHEET = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSyHmU-0ZwmCIFmwaaiC8FLVhSU4n6GNBh4JGtlgf89LWG-4wVW_7Awh8ICilQi5xd5qDVEnfyC2i2O/pub?output=csv";

// Convierte varios formatos de YouTube a embed
function convertirEnlaceYouTube(url) {
  if (!url) return null;
  url = url.trim();
  // embed directo
  let m = url.match(/youtube\.com\/embed\/([a-zA-Z0-9_-]+)/i);
  if (m) return `https://www.youtube.com/embed/${m[1]}`;
  // watch?v=
  m = url.match(/[?&]v=([a-zA-Z0-9_-]{11})/i);
  if (m) return `https://www.youtube.com/embed/${m[1]}`;
  // youtu.be short link
  m = url.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/i);
  if (m) return `https://www.youtube.com/embed/${m[1]}`;
  // shorts
  m = url.match(/youtube\.com\/shorts\/([a-zA-Z0-9_-]+)/i);
  if (m) return `https://www.youtube.com/embed/${m[1]}`;
  // fallback: buscar un id de 11 chars al final
  m = url.match(/([a-zA-Z0-9_-]{11})$/);
  if (m) return `https://www.youtube.com/embed/${m[1]}`;
  return null;
}

function esImagen(url) {
  return /\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i.test(url);
}

async function cargarPublicaciones() {
  const contenedor = document.getElementById('publicaciones') || document.getElementById('lista-publicaciones');
  if (!contenedor) {
    console.error('No se encontr칩 contenedor #publicaciones ni #lista-publicaciones');
    return;
  }
  contenedor.innerHTML = '<p class="text-center text-gray-400">Cargando publicaciones...</p>';

  try {
    const res = await fetch(URL_SHEET);
    if (!res.ok) throw new Error('No se pudo acceder a la hoja (fetch fall칩)');

    const csv = await res.text();
    const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true }).data;
    contenedor.innerHTML = '';

    if (!parsed || parsed.length === 0) {
      contenedor.innerHTML = '<p class="text-center text-gray-400">No hay publicaciones.</p>';
      return;
    }

    // Mostrar m치s recientes primero
    parsed.reverse().forEach(rawRow => {
      // Normalizar claves a min칰sculas y trim valores
      const row = {};
      Object.keys(rawRow).forEach(k => {
        const key = k ? k.trim().toLowerCase() : '';
        row[key] = rawRow[k] ? String(rawRow[k]).trim() : '';
      });

      // Campos esperados: titulo, contenido, imagen, video, fecha
      if (!row.titulo && !row.contenido) return; // ignorar filas vac칤as

      const card = document.createElement('div');
      card.className = 'p-4 bg-gray-50 border border-gray-200 rounded-xl shadow-sm mb-3';

      const h = document.createElement('h3');
      h.className = 'font-semibold text-indigo-600 text-base';
      h.textContent = row.titulo || 'Sin t칤tulo';
      card.appendChild(h);

      if (row.contenido) {
        const p = document.createElement('p');
        p.className = 'mt-1 whitespace-pre-line text-gray-700';
        p.textContent = row.contenido;
        card.appendChild(p);
      }

      // Prioriza columna `video`; si no existe, revisa `imagen`
      let mediaMostrada = false;

      if (row.video) {
        const vid = convertirEnlaceYouTube(row.video);
        if (vid) {
          const div = document.createElement('div');
          div.className = 'mt-4';
          div.innerHTML = `<iframe class="w-full h-52 rounded-lg shadow"
            src="${vid}"
            title="${row.titulo || 'Video'}"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen></iframe>`;
          card.appendChild(div);
          mediaMostrada = true;
        }
      }

      // Si no mostr칩 video, evaluar imagen (o si en imagen hay un video link)
      if (!mediaMostrada && row.imagen) {
        const posibleVid = convertirEnlaceYouTube(row.imagen);
        if (posibleVid) {
          const div = document.createElement('div');
          div.className = 'mt-4';
          div.innerHTML = `<iframe class="w-full h-52 rounded-lg shadow"
            src="${posibleVid}"
            title="${row.titulo || 'Video'}"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen></iframe>`;
          card.appendChild(div);
          mediaMostrada = true;
        } else if (esImagen(row.imagen)) {
          const img = document.createElement('img');
          img.src = row.imagen;
          img.alt = row.titulo || 'Imagen';
          img.className = 'w-full mt-2 rounded-lg shadow-sm';
          card.appendChild(img);
          mediaMostrada = true;
        } else {
          // no es imagen ni video conocido -> mostrar como link
          const a = document.createElement('a');
          a.href = row.imagen;
          a.target = '_blank';
          a.rel = 'noopener';
          a.className = 'text-blue-600 underline block mt-2 break-words';
          a.textContent = row.imagen;
          card.appendChild(a);
        }
      }

      if (row.fecha) {
        const f = document.createElement('p');
        f.className = 'text-xs text-gray-500 mt-2 text-right';
        f.textContent = row.fecha;
        card.appendChild(f);
      }

      contenedor.appendChild(card);
    });

  } catch (err) {
    console.error(err);
    contenedor.innerHTML = '<p class="text-center text-red-500">Error al cargar publicaciones.</p>';
  }
}

document.addEventListener('DOMContentLoaded', cargarPublicaciones);
</script>
</body>
</html>
